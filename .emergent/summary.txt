<analysis>**original_problem_statement:**
The user's initial goal was to launch the app, which included a recently completed Freemium system with Stripe integration. During the pre-deployment checks, the user requested a new feature: a coupon system for 100 early adopters to get one year of Pro access for free. After the agent implemented this and a redeploy occurred, the user reported a critical bug: all user data, including logins and the personal wine cellar, was wiped, reverting to the default state. This is a recurrence of a previously fixed data loss issue.

PRODUCT REQUIREMENTS:
1.  **Critical Bug Fix (P0):** Fix the recurring data loss issue on deployment. User data (,  collections) MUST be persistent and never be overwritten by the seeding script.
2.  **Feature: Coupon System:** Implement a system for 100 one-time-use coupons for early adopters. (Mostly complete, but affected by the data loss bug).
3.  **UI/UX:** Add a coupon redemption field to the subscription page. (Completed, but needs verification after the bug fix).
4.  **Deployment:** Successfully deploy the application with all features and persistent data. (BLOCKED by data loss bug).
5.  **Content:** Provide the user with the list of generated coupon codes and a presentation of the app's features. (Completed).
6.  **Future Features:** PayPal Integration, Google Login, and advanced Pairing Science features remain in the backlog.

**User's preferred language**: German

**what currently exists?**
The application is a full-stack wine platform featuring a Freemium model, user authentication (email/password), and Stripe integration. A new coupon system was just added, with backend APIs, a database collection for codes, and frontend UI on both a dedicated  page and the  page. The agent also created marketing materials (feature list, HTML presentation) and made them available via public URLs. However, a recent deployment has wiped all user data, rendering the login and personal data features non-functional in the live environment.

**Last working item**:
    - Last item agent was working: Investigating a critical data loss issue reported by the user after a redeployment. The user discovered they could no longer log in and their wine cellar was empty.
    - Status: **BLOCKED**
    - Agent Testing Done: N
    - Which testing method agent to use? backend testing agent
    - User Testing Done: Y (User discovered the issue in production)

**All Pending/In progress Issue list**:
  - Issue 1: **(P0) Critical Data Loss on Redeployment**

  Issues Detail:
  - Issue 1: 
     - **Description:** After a deployment, all user-generated data in the  and  collections were wiped and reset to the initial seed data. This prevents logins and deletes user progress.
     - **Attempted fixes:** The  function in  was previously modified to only seed collections if they are empty (). This fix has proven to be insufficient. The logic likely fails to protect the  collection or is being bypassed under certain deployment conditions.
     - **Next debug checklist:**
       1.  **Inspect :** Thoroughly review the  function. The logic that separates system collections (like ) from user collections is flawed. The  collection MUST be added to the list of protected, user-generated collections alongside .
       2.  **Modify the Seeding Logic:** Update the  list in  to explicitly include . This will prevent the script from overwriting existing user accounts.
       3.  **Verify Environment Variables:** Ensure that the  in the production environment is static and not changing, as a new database name would cause the seeding to run from scratch.
       4.  **Test Thoroughly:** After applying the fix, create a test user, add data, restart the server (simulating a redeploy), and verify that the user and their data persist.
     - **Why fix this issue and what will be achieved with the fix?** This is an existential bug. Fixing it will restore the core promise of the application: allowing users to create accounts and save their data. The app is unusable without this fix.
     - **Status:**  IN PROGRESS
     - **Is recurring issue?** Y
     - **Should Test frontend/backend/both after fix?** Backend (primarily), then a full E2E test.
     - **Blocked on other issue:** None. This is the primary blocker.

**In progress Task List**:
No tasks are in progress. All work is blocked by the critical data loss issue.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - **(P0) Deploy Application:** Deploy the fixed application to production.
    - **(P1) PayPal Integration:** Implement PayPal as a second payment option.
    - **(P1) Google Login:** Implement Google Social Login.
- **Future Tasks:**
    - **(P2) Pairing Science - Phase 2:** Evolve the data model with scientific attributes and a Match-Score.
    - **(P3) Pairing Science - Phase 3:** Add UI visualizations (e.g., Radar Charts).
    - **(P3)** Implement an Interaktiver Pairing-Rechner (Interactive Pairing Calculator).

**Completed work in this session**
- **Feature: Coupon System:**
  - Backend: Created APIs (, ), a  collection, and seeding logic for 100 unique codes.
  - Frontend: Created a  page and integrated a redemption form into the  page.
- **Bug Fix: Stripe API Endpoints:** Fixed an issue where Stripe endpoints were defined but not registered in the FastAPI router, causing 404 errors.
- **Bug Fix: Frontend Crash:** Resolved a JavaScript import error in  by correctly exporting  from .
- **Pre-Deployment Hardening:** Fixed several issues in , including missing CORS configuration and hardcoded secrets/URLs.
- **Content Generation:** Created  and  and made them publicly accessible.

**Earlier issues found/mentioned but not fixed**
   - Issue 1: French Wine Hierarchy in Data Source (Low Priority data cleanup).
   - Issue 2: Potential Duplicate Blog Posts (Low Priority data cleanup).

**Known issue recurrence from previous fork**
  - **Issue recurrence in previous fork:** Critical data loss in the  and  collections upon deployment.
  - **Recurrence count:** 2
  - **Status:** **IN PROGRESS**

**Code Architecture**


**Key Technical Concepts**
- **Conditional Database Seeding:** The  function in  is intended to protect user data but is currently failing, leading to data loss on redeployment.
- **Coupon System:** A new system involving a  collection in MongoDB, APIs to redeem and check stats, and UI integration.

**key DB schema**
  - ** (AFFECTED):** . This collection is being incorrectly wiped on deployment.
  - ** (AFFECTED):** . This collection of user-added wines is also being wiped.
  - ** (NEW):** 

**changes in tech stack**
  - No new libraries were added.

**All files of reference**
- : **CRITICAL FILE.** The  function within this file is the source of the data loss bug and must be fixed.
- : New page for coupon redemption.
- : Modified to include the coupon form.
- : Modified to fix a critical frontend bug.
- : Source file for the generated coupon codes.

**key api endpoints**
-  (NEW): Redeems a coupon for a user.
-  (NEW): Gets statistics on coupon usage.

**Critical Info for New Agent**
- **IMMEDIATE PRIORITY:** You must fix the critical data loss bug in . The  function is wiping the  and  collections on every deployment. The previous fix was incomplete. The  collection was never added to the protected user collections list, which is a likely cause. This is a recurring, P0 issue that makes the app unusable.
- **Communicate in German:** All communication with the user must be in German.
- **Context:** The user is justifiably frustrated with the recurring data loss. Acknowledge this and be very clear about how you will permanently fix the issue and verify the fix before deploying again.

**documents created in this job**
  - 
  - 
  - 
  - 
  - 

**Last 10 User Messages and any pending user messages**
- **Last Msg:** User asks if the agent can roll back to a previous version after discovering the data loss. (Pending)
- **Msg 9:** User reports the critical data loss: can't log in, wine cellar is empty. (Pending)
- **Msg 8:** User asks for market data to be added to the presentation. (Completed)
- **Msg 7:** User reports the links to the presentation/feature list are broken. (Completed)
- **Msg 6:** User asks for a presentation of the app's features. (Completed)
- **Msg 5-1:** A series of messages resolving a DNS issue with the user's custom domain . (Completed)

**Project Health Check:**
- **Broken:** Yes. The core data persistence functionality is broken, leading to complete data loss for users on deployment.

**3rd Party Integrations**
- **OpenAI:** Used for content generation. Uses Emergent LLM Key.
- **Stripe:** Integrated for handling Pro plan payments. Uses a User-provided API Key.

**Testing status**
  - Testing agent used after significant changes: NO
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: None
  - Known regressions: **CRITICAL REGRESSION:** The data persistence logic has failed again, causing user data to be wiped on deployment.

**Credentials to test flow:**
Any user credentials created will be wiped upon the next deployment until the seeding bug is fixed. A test user ( / ) was used for local tests.

**What agent forgot to execute**
The agent failed to ensure the  collection was added to the list of protected, non-seedable collections when implementing the coupon feature. This oversight on a known sensitive area of the code likely led directly to the critical data loss regression.</analysis>
